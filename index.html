<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sci-Fi Typing Tutor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            color: #00ff88;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            animation: glow 2s ease-in-out infinite alternate;
        }

        .header h1 {
            font-size: 2.5rem;
            text-shadow: 0 0 20px #00ff88;
            margin-bottom: 10px;
        }

        .config-panel {
            background: rgba(0, 255, 136, 0.1);
            border: 2px solid #00ff88;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .config-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .config-row label {
            min-width: 120px;
            font-weight: bold;
        }

        .config-row input, .config-row select, .config-row button {
            padding: 8px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00ff88;
            border-radius: 5px;
            color: #00ff88;
            font-family: inherit;
        }

        .config-row input {
            flex: 1;
            min-width: 200px;
        }

        .config-row button {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .config-row button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }

        .config-row button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid #00ff88;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #00ff88;
            text-shadow: 0 0 10px #00ff88;
        }

        .stat-label {
            font-size: 0.9rem;
            margin-top: 5px;
            opacity: 0.8;
        }

        .text-display {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff88;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            min-height: 200px;
            font-size: 1.2rem;
            line-height: 1.8;
            position: relative;
            overflow: hidden;
        }

        .text-display::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #00ff88, #0066ff, #ff0066, #00ff88);
            border-radius: 10px;
            z-index: -1;
            animation: borderAnimation 3s linear infinite;
        }

        .word {
            display: inline-block;
            margin-right: 0.3em;
            padding: 2px 4px;
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        .word.current {
            background: rgba(0, 255, 136, 0.3);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
            transform: scale(1.05);
        }

        .word.completed {
            color: #666;
            opacity: 0.6;
        }

        .word.error {
            background: rgba(255, 0, 102, 0.3);
            box-shadow: 0 0 15px rgba(255, 0, 102, 0.5);
        }

        .input-area {
            position: relative;
        }

        .typing-input {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff88;
            border-radius: 10px;
            color: #00ff88;
            font-family: inherit;
            outline: none;
            transition: all 0.3s ease;
        }

        .typing-input:focus {
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            border-color: #00ccff;
        }

        .loading {
            text-align: center;
            font-size: 1.2rem;
            color: #00ff88;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .error-message {
            background: rgba(255, 0, 102, 0.2);
            border: 1px solid #ff0066;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            color: #ff6b9d;
        }

        .success-message {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid #00ff88;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            color: #00ff88;
        }

        @keyframes glow {
            from { text-shadow: 0 0 20px #00ff88; }
            to { text-shadow: 0 0 30px #00ff88, 0 0 40px #00ff88; }
        }

        @keyframes borderAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00ccff);
            border-radius: 4px;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .config-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .config-row label {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Sci-Fi Typing Tutor</h1>
            <p>Master your typing skills through galactic adventures</p>
        </div>

        <div class="config-panel">
            <div class="config-row">
                <label for="apiKey">OpenAI API Key:</label>
                <input type="password" id="apiKey" placeholder="sk-... (Note: Browser CORS prevents direct API calls)" />
                <button id="saveKey">Save Key</button>
            </div>
            
            <div class="config-row">
                <label for="storyLength">Story Length:</label>
                <select id="storyLength">
                    <option value="short">Short (50-100 words)</option>
                    <option value="medium" selected>Medium (100-200 words)</option>
                    <option value="long">Long (200-300 words)</option>
                </select>
                <button id="generateStory">Generate New Story</button>
                <button id="resetTest">Reset Test</button>
            </div>
            
            <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid #00ff88; border-radius: 5px; padding: 10px; margin-top: 10px; font-size: 0.9rem;">
                <strong>üåê Shared API Key:</strong> API keys are saved on the server and shared across all users on the network. Anyone can save a key, and everyone will be able to use AI-generated stories!
            </div>
        </div>

        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-value" id="wpm">0</div>
                <div class="stat-label">Words Per Minute</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="accuracy">100%</div>
                <div class="stat-label">Accuracy</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="progress">0%</div>
                <div class="stat-label">Progress</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="timeElapsed">0:00</div>
                <div class="stat-label">Time Elapsed</div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="text-display" id="textDisplay">
            <div class="loading">Loading your sci-fi adventure...</div>
        </div>

        <div class="input-area">
            <input type="text" class="typing-input" id="typingInput" placeholder="Start typing the story above..." disabled />
        </div>

        <div id="messages"></div>
    </div>

    <script>
        class SciFiTypingTutor {
            constructor() {
                this.apiKey = '';
                this.currentStory = '';
                this.words = [];
                this.currentWordIndex = 0;
                this.currentCharIndex = 0;
                this.startTime = null;
                this.errors = 0;
                this.totalTypedChars = 0;
                this.isTestActive = false;
                this.timerInterval = null;
                
                this.initializeElements();
                this.bindEvents();
                this.loadApiKeyFromServer();
                this.generateInitialStory();
            }

            initializeElements() {
                this.apiKeyInput = document.getElementById('apiKey');
                this.storyLengthSelect = document.getElementById('storyLength');
                this.textDisplay = document.getElementById('textDisplay');
                this.typingInput = document.getElementById('typingInput');
                this.wpmDisplay = document.getElementById('wpm');
                this.accuracyDisplay = document.getElementById('accuracy');
                this.progressDisplay = document.getElementById('progress');
                this.timeDisplay = document.getElementById('timeElapsed');
                this.progressFill = document.getElementById('progressFill');
                this.messagesDiv = document.getElementById('messages');
            }

            bindEvents() {
                document.getElementById('saveKey').addEventListener('click', () => this.saveApiKey());
                document.getElementById('generateStory').addEventListener('click', () => this.generateStory());
                document.getElementById('resetTest').addEventListener('click', () => this.resetTest());
                this.typingInput.addEventListener('input', (e) => this.handleTyping(e));
                this.typingInput.addEventListener('keydown', (e) => this.handleKeyDown(e));
            }

            async loadApiKeyFromServer() {
                try {
                    const response = await fetch('/api/get-key');
                    if (response.ok) {
                        const data = await response.json();
                        this.apiKey = data.apiKey || '';
                        this.apiKeyInput.value = this.apiKey;
                        if (this.apiKey) {
                            this.showMessage(`üîë API key loaded from server (${this.apiKey.substring(0, 7)}...)`, 'success');
                        }
                    }
                } catch (error) {
                    console.error('Error loading API key from server:', error);
                }
            }

            loadApiKey() {
                // Legacy method - now handled by loadApiKeyFromServer
                // Keeping for compatibility
            }

            async saveApiKey() {
                const key = this.apiKeyInput.value.trim();
                if (key) {
                    try {
                        const response = await fetch('/api/save-key', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ apiKey: key })
                        });

                        if (response.ok) {
                            this.apiKey = key;
                            this.showMessage('‚úÖ API key saved to server! All users can now generate AI stories.', 'success');
                        } else {
                            const errorData = await response.json();
                            this.showMessage(`‚ùå Error saving API key: ${errorData.error}`, 'error');
                        }
                    } catch (error) {
                        console.error('Error saving API key:', error);
                        this.showMessage('‚ùå Error saving API key to server.', 'error');
                    }
                } else {
                    this.showMessage('Please enter a valid API key.', 'error');
                }
            }

            async generateStory() {
                const button = document.getElementById('generateStory');
                button.disabled = true;
                button.textContent = 'Generating...';

                this.textDisplay.innerHTML = '<div class="loading">Generating your sci-fi adventure...</div>';

                // Check if API key is provided
                if (!this.apiKey) {
                    this.showMessage('‚ö†Ô∏è API key not set. Using pre-written sci-fi stories instead. Add your OpenAI API key to generate custom stories!', 'error');
                    this.loadRandomFallbackStory();
                    button.disabled = false;
                    button.textContent = 'Generate New Story';
                    return;
                }

                try {
                    // Use server endpoint that automatically uses saved API key
                    const response = await fetch('/api/generate-story', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            storyLength: this.storyLengthSelect.value
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.currentStory = data.story;
                        this.setupTypingTest();
                        this.showMessage('‚ú® New AI story generated! Start typing to begin.', 'success');
                        return;
                    } else {
                        throw new Error(`Server error: ${response.status}`);
                    }

                } catch (error) {
                    console.error('Error generating story:', error);
                    
                    // If local server is not available, show helpful message
                    if (error.message.includes('Failed to fetch') || error.message.includes('Server error')) {
                        this.showMessage('üñ•Ô∏è Local server not detected. Using pre-written stories. To use AI generation, run the local server setup!', 'error');
                    } else {
                        this.showMessage('Error generating story. Please check your API key and try again.', 'error');
                    }
                    
                    this.loadRandomFallbackStory();
                } finally {
                    button.disabled = false;
                    button.textContent = 'Generate New Story';
                }
            }

            loadRandomFallbackStory() {
                const stories = [
                    "Captain Nova pressed the hyperdrive button as alien fighters approached her starship. The quantum engines roared to life, bending space and time around the vessel. Through the viewport, she watched stars stretch into brilliant lines of light. Her android companion calculated their escape trajectory while monitoring the pursuing fleet. The ship burst through a wormhole, emerging in an unknown galaxy filled with mysterious nebulae and ancient space stations. Their mission to find the lost colony ship had taken an unexpected turn into uncharted territory.",

                    "Commander Zara activated her plasma rifle as the alien creature emerged from the crashed meteorite. Its crystalline form pulsed with otherworldly energy, casting rainbow lights across the barren moon surface. The creature seemed to communicate through harmonic vibrations that resonated through her suit. Behind her, the research team prepared their scientific instruments while maintaining a safe distance. This first contact scenario was nothing like the simulations back on Earth. The creature extended what appeared to be a peaceful gesture toward the human explorers.",

                    "The space station trembled as massive solar flares erupted from the nearby star. Engineer Kai raced through the corridors, adjusting power relays and rerouting energy systems to protect the inhabitants. Emergency lights flickered while automated systems announced evacuation protocols. Through the observation deck windows, he could see rescue ships approaching from the distant planet below. The magnetic shields were holding, but barely. Time was running out to save the thousand colonists who called this orbital facility home.",

                    "Dr. Elena Martinez stepped onto the surface of the newly discovered planet, her boots sinking slightly into the purple sand. Above her, two moons cast an ethereal glow across the landscape of towering crystal formations. Her scanning device detected unusual energy readings from the ancient ruins ahead. The archaeological team had traveled fifty light-years to study this mysterious civilization. Strange symbols carved into the crystal structures seemed to pulse with their own inner light, suggesting advanced technology beyond human understanding.",

                    "Pilot Rex engaged the cloaking device as enemy ships patrolled the asteroid field. His small fighter craft drifted silently between the floating rocks, invisible to their sensors. The rebel base hidden within the largest asteroid was counting on him to deliver the stolen data files. Through his cockpit window, he watched patrol vessels search methodically through the debris field. One wrong move would expose not only himself but the entire resistance movement. The fate of the galaxy hung in the balance of this dangerous mission.",

                    "The terraforming machine hummed to life on the barren world, beginning its century-long task of creating a breathable atmosphere. Scientist Dr. Kim watched the initial atmospheric processors release their chemical compounds into the thin air. Robotic drones scattered across the landscape, planting genetically modified organisms designed to thrive in harsh conditions. This would become humanity's first new home outside the solar system. The colonists in cryogenic sleep aboard the orbiting ship would awaken to find a garden world waiting for them.",

                    "Ambassador Chen stood before the Galactic Council, representing Earth in its first official diplomatic contact with alien civilizations. The chamber contained beings from dozens of different worlds, each with unique forms and communication methods. Universal translators converted her words into thousands of different languages and energy patterns. The debate concerned mining rights in a disputed star system that contained rare elements essential for faster-than-light travel. Her next words could determine whether humanity would be welcomed into the galactic community or face eternal isolation."
                ];

                // Select story based on length preference
                const lengthPreference = this.storyLengthSelect.value;
                let selectedStories = stories;
                
                if (lengthPreference === 'short') {
                    // Use first half of each story for shorter length
                    selectedStories = stories.map(story => {
                        const words = story.split(' ');
                        return words.slice(0, Math.floor(words.length * 0.6)).join(' ');
                    });
                } else if (lengthPreference === 'long') {
                    // Keep full stories for long option
                    selectedStories = stories;
                }

                const randomIndex = Math.floor(Math.random() * selectedStories.length);
                this.currentStory = selectedStories[randomIndex];
                this.setupTypingTest();
            }

            loadFallbackStory() {
                // Legacy method - now calls the random version
                this.loadRandomFallbackStory();
            }

            async generateInitialStory() {
                // Always start with fallback stories since API calls don't work in browsers
                this.loadRandomFallbackStory();
            }

            setupTypingTest() {
                this.words = this.currentStory.split(/\s+/).filter(word => word.length > 0);
                this.currentWordIndex = 0;
                this.currentCharIndex = 0;
                this.errors = 0;
                this.totalTypedChars = 0;
                this.isTestActive = false;
                this.startTime = null;
                
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                }

                this.renderText();
                this.updateStats();
                this.typingInput.disabled = false;
                this.typingInput.value = '';
                this.typingInput.focus();
            }

            renderText() {
                const textHtml = this.words.map((word, index) => {
                    let className = 'word';
                    if (index < this.currentWordIndex) {
                        className += ' completed';
                    } else if (index === this.currentWordIndex) {
                        className += ' current';
                    }
                    return `<span class="${className}">${word}</span>`;
                }).join(' ');

                this.textDisplay.innerHTML = textHtml;
            }

            handleKeyDown(e) {
                // Start test on first keystroke
                if (!this.isTestActive) {
                    this.startTest();
                }

                if (e.key === ' ') {
                    e.preventDefault();
                    this.handleSpaceKey();
                } else if (e.key === 'Backspace') {
                    // Allow backspace but update status
                    setTimeout(() => this.handleTyping(e), 0);
                }
            }

            handleTyping(e) {
                const typed = e.target.value;
                const currentWord = this.words[this.currentWordIndex];
                
                if (!currentWord) return;

                // Update visual feedback based on current typing
                if (currentWord.startsWith(typed) && typed.length <= currentWord.length) {
                    // Still typing the word correctly
                    this.updateCurrentWordStatus(false);
                } else {
                    // Error in typing
                    this.updateCurrentWordStatus(true);
                }

                this.updateStats();
            }

            handleSpaceKey() {
                const typed = this.typingInput.value.trim();
                const currentWord = this.words[this.currentWordIndex];

                if (!currentWord) return;

                // Check if the typed word matches the current word
                if (typed === currentWord) {
                    // Correct word
                    this.completeCurrentWord();
                } else {
                    // Incorrect word - mark as error and move to next
                    this.errors++;
                    this.completeCurrentWord();
                }
            }

            completeCurrentWord() {
                const typedWord = this.typingInput.value.trim();
                const currentWord = this.words[this.currentWordIndex];
                
                // Count characters typed (including the space)
                this.totalTypedChars += typedWord.length + 1;
                
                // Move to next word
                this.currentWordIndex++;
                this.typingInput.value = '';

                // Check if test is complete
                if (this.currentWordIndex >= this.words.length) {
                    this.endTest();
                } else {
                    this.renderText();
                    this.updateStats();
                }
            }

            updateCurrentWordStatus(hasError) {
                const currentWordElement = document.querySelector('.word.current');
                if (currentWordElement) {
                    if (hasError) {
                        currentWordElement.classList.add('error');
                    } else {
                        currentWordElement.classList.remove('error');
                    }
                }
            }

            startTest() {
                this.isTestActive = true;
                this.startTime = Date.now();
                this.timerInterval = setInterval(() => {
                    this.updateStats();
                }, 100);
            }

            endTest() {
                this.isTestActive = false;
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                }
                
                this.typingInput.disabled = true;
                this.showMessage('Test completed! Great job on improving your typing speed!', 'success');
                this.updateStats();
            }

            resetTest() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                }
                
                this.setupTypingTest();
                this.showMessage('Test reset. Start typing to begin again.', 'success');
            }

            updateStats() {
                // Calculate WPM
                const timeElapsed = this.startTime ? (Date.now() - this.startTime) / 1000 / 60 : 0;
                const wordsTyped = this.currentWordIndex;
                const wpm = timeElapsed > 0 ? Math.round(wordsTyped / timeElapsed) : 0;

                // Calculate accuracy
                const totalWords = Math.max(this.currentWordIndex, 1);
                const correctWords = totalWords - this.errors;
                const accuracy = Math.round((correctWords / totalWords) * 100);

                // Calculate progress
                const progress = Math.round((this.currentWordIndex / this.words.length) * 100);

                // Format time
                const totalSeconds = Math.floor(timeElapsed * 60);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                const timeFormatted = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                // Update displays
                this.wpmDisplay.textContent = wpm;
                this.accuracyDisplay.textContent = `${accuracy}%`;
                this.progressDisplay.textContent = `${progress}%`;
                this.timeDisplay.textContent = timeFormatted;
                this.progressFill.style.width = `${progress}%`;
            }

            showMessage(message, type) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `${type}-message`;
                messageDiv.textContent = message;
                
                this.messagesDiv.innerHTML = '';
                this.messagesDiv.appendChild(messageDiv);
                
                setTimeout(() => {
                    messageDiv.remove();
                }, 5000);
            }
        }

        // Initialize the typing tutor when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new SciFiTypingTutor();
        });
    </script>
</body>
</html>